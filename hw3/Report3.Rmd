---
title: "Script3Report"
author: "Вейбер Е.Н. 23.М08-мм"
output: html_document
date: "2024-03-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Введение

В этом отчете представлен кластерный анализ пользователей сервиса TripAdvisor и их предпочтений.

## Загрузка данных

Данные об оценках пользователей были загружены и проверены с помощью следующего кода:

```{r load-data, echo=TRUE}
library(tidyverse)
library(ggplot2)
library(readr)
library(corrplot)
library(tidyr)
library(GGally)
library(plotly)
library(stats)
library(reshape2)

# Загрузка данных и создание гистограмм
data <- read_csv("~/Downloads/tripadvisor_review.csv")
head(data)

summary(data)
```

Для упрощения интерпретации анализа названия столбцов были изменены в соответствии с описанием датасета:
```{r}
names(data) <- c("user id", "art galleries", "dance clubs", "juice bars", "restaurants", "museums", "resorts", "parks/picnic spots", "beaches", "theatres", "religious institutions")
```

Был проведен корреляционный анализ и шкалирование:
```{r}
#Корреляционный анализ
cor_matrix <- cor(data[,c("art galleries", "dance clubs", "juice bars", "restaurants", "museums", "resorts", "parks/picnic spots", "beaches", "theatres", "religious institutions")])

# Визуализация корреляционной матрицы
corrplot::corrplot(cor_matrix, method = "circle")
print(cor_matrix)

# Шкалирование
scaled_data <- scale(data[,c(2:6,8:10)])
scaled_data <- as.data.frame(scaled_data)

# Вычисление и анализ матрицы корреляции масштабированных данных
cor_matrix_scaled <- cor(scaled_data)
corrplot::corrplot(cor_matrix_scaled, method = "circle")
print(cor_matrix_scaled)
```

Датасет был разделен на 5 кластеров:
```{r}
# Использование функции kmeans для разделения данных на 5 кластеров
set.seed(42) # Устанавливаем seed для воспроизводимости k-средних
kmeans_result <- kmeans(scaled_data, centers = 5)

# Посмотрим результаты кластеризации
print(kmeans_result)

library(FactoMineR)
data(iris)
res.pca <- PCA(iris[,1:4], graph=FALSE)

# Смотрим долю объясненной вариативности
print(res.pca$eig)

# Строим график каменистой осыпи
plot(res.pca$eig[,1], type="b", xlab="Номер компоненты", ylab="Процент объясненной вариативности",
     main="График каменистой осыпи")

#график каменистой осыпи указывает на оптимальное число главных компонент для использования(3)

cluster_labels <- kmeans_result$cluster
# Выполнение PCA для сокращения данных до 3 измерений
pca_result <- prcomp(scaled_data, center = TRUE, scale. = TRUE)
principal_components <- pca_result$x[, 1:3]

# Создание нового датафрейма для визуализации
pca_df <- data.frame(principal_components)
pca_df$Cluster <- as.factor(cluster_labels) # Преобразование меток кластера в фактор для цветовой кодировки

# Преобразование фактора в числовой формат перед вычислением максимального значения
num_clusters <- as.numeric(levels(pca_df$Cluster))[pca_df$Cluster]

# Создание 3D графика с использованием plotly
fig <- plot_ly(data = pca_df, x = ~PC1, y = ~PC2, z = ~PC3, color = ~Cluster, colors = RColorBrewer::brewer.pal(max(num_clusters), "Set1"), type = "scatter3d", mode = "markers") %>%
  layout(scene = list(xaxis = list(title = "PC1"),
                      yaxis = list(title = "PC2"),
                      zaxis = list(title = "PC3")),
         margin = list(l = 0, r = 0, b = 0, t = 0))

# Показ графика
fig
```

Были вычислены средние значения для каждого кластера по всем столбцам:
```{r}
# scaled_data - это масштабированный датафрейм, а cluster_labels - вектор меток кластера
# добавим к scaled_data метки кластера
scaled_data$Cluster <- cluster_labels
# Вычисление средних значений для каждого кластера по всем столбцам
library(dplyr)
cluster_means <- scaled_data %>%
  group_by(Cluster) %>%
  summarise_all(mean)

# Выводим результат
print(cluster_means)
dplyr::glimpse(cluster_means)
```

Построены boxplot'ы для визуализации средних оценок локаций в каждом кластере:
```{r}
# Построение ящиков с усами
# Преобразование данных из широкого формата в длинный
df_long <- gather(scaled_data, key = "Category", value = "Score", -Cluster)
ggplot(df_long, aes(x = Cluster, y = Score, fill = factor(Cluster))) +
  geom_boxplot() +
  facet_wrap(~ Category, scales = "free") + # Разбивка по категориям
  theme_light() +
  labs(y = "Оценки", fill = "Кластер") +
  scale_fill_brewer(palette = "Set3") # Использование палитры 'Set3' для цветов
```

Был произведен статистический вывод:
```{r}
# Статистический вывод между "art galleries" и "beaches"
cor_test_art_beaches <- cor.test(scaled_data$"art galleries", scaled_data$beaches)
print("Корреляция между 'art galleries' и 'beaches':")
print(cor_test_art_beaches)

# Статистический вывод между "art galleries" и "beaches" с использованием попарного t-критерия
t_test_result <- t.test(scaled_data$"art galleries", scaled_data$beaches, paired = TRUE)

# Вывод результатов теста
print(t_test_result)
```

## Интерпретация результатов

### Интерпретация корреляционного анализа до масштабирования данных
* *Положительные корреляции*:  
Сильная корреляция между "parks/picnic spots" и "juice bars" (коэффициент ~0.75), может указывать на то, что люди, которым нравятся парки и места для пикников, также склонны высоко оценивать сок-бары.
"Museums" и "resorts" имеют довольно высокую корреляцию (~0.58), а также "resorts" и "parks/picnic spots" (~0.43), что может отражать общие интересы посетителей этих мест.  
* *Отрицательные корреляции*:  
Самая сильная отрицательная корреляция наблюдается между "religious institutions" и "parks/picnic spots" (~-0.71), что может указывать на то, что интерес к религиозным учреждениям и паркам или местам для пикников редко сочетаются в предпочтениях пользователей.
"Juice bars" и "religious institutions" также показывают значительную отрицательную корреляцию (-0.44), подобно "restaurants" и "religious institutions" (-0.35).

### Интерпретация корреляционного анализа после масштабирования данных  
Важно отметить, что обе матрицы идентичны, что указывает на то, что масштабирование данных не изменило структуру корреляций между признаками. Это ожидаемо, поскольку масштабирование изменяет масштаб данных, но не их внутренние взаимосвязи.

### Анализ результатов кластеризации и средних оценок локаций для каждого кластера

* **Кластер 1** содержит 21 наблюдение. Выделяется очень высокими средними оценками по "restaurants", что может указывать на группу пользователей с особым интересом к ресторанам. Является наименьшим по размеру (21 точка), имеет самую низкую внутрикластерную сумму квадратов. Это может указывать на то, что точки в этом кластере находятся относительно близко друг к другу, что свидетельствует о высокой степени схожести в предпочтениях пользователей этой группы. 
* **Кластер 2** — 225 наблюдений. Имеет высокие средние значения для "beaches" и "theatres", что может отражать интересы группы к пляжам и театрам. Самый крупный по численности (225 точек), имеет самую высокую WCSS, что может указывать на большую диверсификацию в предпочтениях пользователей внутри этого кластера.
* **Кластер 3** — 320 наблюдений. Характеризуется относительно низкими средними значениями по большинству признаков, что может указывать на более критично настроенных пользователей или тех, кто реже ставит высокие оценки.
* **Кластер 4** — 198 наблюдений. Имеет высокие средние значения для "juice bars", "museums" и "parks/picnic spots", что может свидетельствовать о группе пользователей с интересом к здоровому образу жизни и культурному досугу.
* **Кластер 5** — 216 наблюдений. Выделяется высокими средними оценками по "museums", возможно, отражая группу с высоким интересом к музеям.

### Анализ результатов попарного t-критерия для признаков "art galleries" и "beaches"  
* *t-статистика*: Значение t-статистики очень близко к нулю (-6.8242e-13), что указывает на очень маленькую разницу в средних значениях между двумя группами.
* *P-значение* равно 1, что значительно выше стандартного порога статистической значимости. Это указывает на отсутствие статистически значимых различий в средних оценках между "art galleries" и "beaches".
* *95% доверительный интервал* для разницы средних лежит в диапазоне от -0.08775944 до 0.08775944. Поскольку этот интервал включает в себя 0, это подтверждает вывод о том, что средние оценки для этих двух признаков статистически не отличаются.
* *Средняя разница* между оценками составляет примерно -3.051833e-14, что ещё раз подтверждает, что различие между средними оценками "art galleries" и "beaches" практически незаметно и не имеет статистической значимости.  
Результаты парного t-теста говорят о том, что между оценками "art galleries" и "beaches", даными пользователями, нет статистически значимых различий. Это может означать, что предпочтения пользователей относительно этих двух типов локаций схожи или что изменения в оценках одного типа локации не связаны с изменениями в оценках другого. 




