---
title: "Анализ данных о медицинских расходах"
author: "Вейбер Е.Н. 23.М08-мм"
date: "07-03-2024"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Введение

В этом отчете проведен анализ данных о медицинских расходах с целью выявления особенностей распределения ключевых переменных, а также оценки влияния пола на эти расходы и изучения взаимосвязей между различными переменными.

## Загрузка данных

Данные о медицинских расходах были загружены и проверены с помощью следующего кода:

```{r load-data, echo=TRUE}
# Загрузка необходимых библиотек
library(tidyverse)
library(ggplot2)
library(readr)
library(corrplot)

# Шаг 1: Загрузка данных и создание гистограмм
data <- read_csv("~/Downloads/mexpenditures.csv")
head(data)
```

## Гистограммы частот

Гистограммы частот были созданы с помощью следующего кода:

```{r}
# Создание гистограмм для возраста, BMI и расходов
ggplot(data, aes(x=age)) +
  geom_histogram(bins=30, fill='blue', color='black') +
  ggtitle("Гистограмма возраста") +
  theme_minimal()

ggplot(data, aes(x=bmi)) +
  geom_histogram(bins=30, fill='green', color='black') +
  ggtitle("Гистограмма BMI") +
  theme_minimal()

ggplot(data, aes(x=charges)) +
  geom_histogram(bins=30, fill='red', color='black') +
  ggtitle("Гистограмма медицинских расходов") +
  theme_minimal()
```

## Выбросы

Для анализа выбросов был использован boxplot:

```{r}
# Подробнее про выбросы

# Функция boxplot возвращает список, одним из элементов которого является $out, содержащий выбросы
get_boxplot_outliers <- function(variable) {
  bp <- boxplot(variable, plot = FALSE)  # plot=FALSE чтобы не создавать график
  return(bp$out)
}

# Получаем выбросы для 'age', 'bmi', 'charges'
outliers_age <- get_boxplot_outliers(data$age)
outliers_bmi <- get_boxplot_outliers(data$bmi)
outliers_charges <- get_boxplot_outliers(data$charges)

# Выводим количество выбросов
length(outliers_age)
length(outliers_bmi)
length(outliers_charges)

# Визуализация выбросов с помощью boxplot для каждой переменной
par(mfrow=c(1,3))  # Определяем макет для 3 графиков в одной строке

# Возраст
boxplot(data$age, main="Boxplot возраста", horizontal = TRUE, col = "lightblue")

# BMI
boxplot(data$bmi, main="Boxplot BMI", horizontal = TRUE, col = "lightgreen")

# Медицинские расходы
boxplot(data$charges, main="Boxplot медицинских расходов", horizontal = TRUE, col = "lightcoral")

# Восстановление стандартного макета графиков
par(mfrow=c(1,1))
```

## Сравнение выраженности непрерывных признаков между группами мужчин и женщин

Выбор статистического теста зависел от нормальности распределения и был реализован функцией perform_statistical_test:

```{r}
# Функция для выполнения статистического теста в зависимости от нормальности распределения
perform_statistical_test <- function(data, variable) {
  # Проверка на нормальность для мужчин и женщин
  shapiro_test_women <- shapiro.test(data[data$sex == 'female', ][[variable]])
  shapiro_test_men <- shapiro.test(data[data$sex == 'male', ][[variable]])
  
  # Выбор и выполнение теста
  if (shapiro_test_women$p.value > 0.05 && shapiro_test_men$p.value > 0.05) {
    # Если распределения нормальные, применяем t-тест
    test_result <- t.test(data[[variable]] ~ data$sex)
  } else {
    # Иначе применяем непараметрический тест Манна-Уитни
    test_result <- wilcox.test(data[[variable]] ~ data$sex)
  }
  
  # Возвращаем результат
  return(test_result)
}

# Применяем функцию к переменным 'age', 'bmi', 'charges'
test_result_age <- perform_statistical_test(data, 'age')
test_result_bmi <- perform_statistical_test(data, 'bmi')
test_result_charges <- perform_statistical_test(data, 'charges')

# Выводим результаты тестов
print("Результаты теста для возраста:")
print(test_result_age)

print("Результаты теста для BMI:")
print(test_result_bmi)

print("Результаты теста для медицинских расходов:")
print(test_result_charges)
```

## Корреляционный анализ

```{r}
# Шаг 3: Корреляционный анализ
cor_matrix <- cor(data[,c('age', 'bmi', 'charges')])

# Визуализация корреляционной матрицы
corrplot::corrplot(cor_matrix, method = "circle")
print(cor_matrix)
```

## Интерпретация результатов

### Анализ гистограмм непрерывных признаков

На гистограмме возраста (age) видно равномерное распределение. Не наблюдается значительных выбросов.

Гистограмма индекса массы тела (bmi) имеет приближённо нормальное распределение. Выбросы присутствуют в правой части распределения, так как есть значения далеко превышающие среднее.

Гистограмма медицинских расходов (charges) имеет скошенное вправо распределение, с длинным "хвостом" высоких значений, что указывает на наличие выбросов. Большая часть расходов сосредоточена в левой части графика, но есть значительное количество очень высоких значений.

### Анализ выбросов

На основе межквартильного размаха (IQR) было определено, что:

1. Для признака age выбросов не обнаружено.
2. Для признака bmi обнаружено 9 выбросов.
3. Для признака charges обнаружено 139 выбросов.

Выбросы в bmi и charges, возможно, указывают на особенности в данных, которые могут быть связаны с редкими заболеваниями или высокой стоимостью медицинских услуг. 

### Анализ выраженности непрерывных признаков между группами мужчин и женщин

* **Результаты теста для возраста:**
*P-значение = 0.4468* показывает отсутствие статистически значимых различий в возрасте между мужчинами и женщинами в данном наборе данных.
* **Результаты теста для BMI:**
*P-значение = 0.1014.* Также, как и с возрастом, нет достаточных доказательств статистически значимых различий в индексе массы тела между мужчинами и женщинами.
* **Результаты теста для медицинских расходов:**
*P-значение = 0.7287* указывает на отсутствие статистически значимых различий в медицинских расходах между мужчинами и женщинами. Очень высокое p-значение может говорить о том, что любые наблюдаемые различия в медицинских расходах между полами скорее всего случайны.
* **Общий вывод:**
В целом, результаты тестов показывают, что в данном наборе данных не наблюдается статистически значимых различий по возрасту, индексу массы тела (BMI) и медицинским расходам между мужчинами и женщинами. Вероятно, для этих переменных пол не является дифференцирующим фактором, влияющим на их значения в представленном наборе данных.

### Анализ корреляции непрерывных признаков

Матрица корреляции показывает следующие коэффициенты корреляции Пирсона между непрерывными переменными:

* *Возраст (age)* и *медицинские расходы (charges)* : 0.30, что указывает на небольшую положительную корреляцию.
* *Индекс массы тела (bmi)*  и *медицинские расходы (charges)* : 0.20, что также указывает на небольшую положительную корреляцию.
* *Возраст (age)*  и *индекс массы тела (bmi)*: 0.11, что говорит о очень слабой положительной корреляции.  
Интерпретируя эти результаты, можно сказать, что медицинские расходы имеют тенденцию увеличиваться с возрастом и с повышением BMI, но эти взаимосвязи не очень сильные.

## Вывод

Анализ показал, что данные о медицинских расходах, индексе массы тела и возрасте характеризуются разнообразными распределениями и содержат как равномерно распределенные, так и скошенные переменные. При этом не было выявлено значимых различий между мужчинами и женщинами по этим параметрам, что может свидетельствовать об отсутствии их зависимости от пола в данной выборке. В то же время, некоторые корреляции между переменными намекают на возможные связи, требующие дальнейшего изучения.
